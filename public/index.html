<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 Upside Predictor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 16px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .auth-section { background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .auth-section button { background: #0284c7; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 4px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #0284c7; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        h1 { font-size: 24px; color: #1a202c; margin-bottom: 8px; }
        .watchlist-btn { background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .watchlist-btn.added { background: #6b7280; }
        .stock-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stock-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .stock-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .stock-symbol { font-size: 20px; font-weight: 700; color: #1a202c; }
        .stock-price { font-size: 24px; font-weight: 700; margin: 12px 0; }
        .upside-box { background: #d1fae5; padding: 12px; border-radius: 8px; margin: 12px 0; }
        .upside-value { font-size: 22px; font-weight: 700; color: #059669; }
        .loading { text-align: center; padding: 40px; color: white; font-size: 18px; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .my-watchlist { background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        .watchlist-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .remove-btn { background: #ef4444; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .error-box { background: #fee; border: 2px solid #f44; color: #c00; padding: 12px; border-radius: 8px; margin: 12px 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
        .modal-close { position: absolute; top: 16px; right: 16px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; font-weight: bold; }
        .score-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; }
        .score-card { background: #f9fafb; border-radius: 8px; padding: 16px; }
        .score-label { font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .score-value { font-size: 28px; font-weight: 700; color: #1a202c; }
        .indicator-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .indicator-label { font-weight: 600; color: #374151; }
        .indicator-value { color: #059669; font-weight: 600; }
        .section-title { font-size: 18px; font-weight: 700; color: #1a202c; margin: 24px 0 12px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
        .calculation-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 12px 0; border-radius: 4px; }
        .tab-button { background: white; border: none; padding: 12px 24px; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #0284c7; border-bottom-color: #0284c7; }
        .tab-button:hover { background: #f3f4f6; }
        .stat-card { background: #f9fafb; border-radius: 8px; padding: 20px; border-left: 4px solid #0284c7; }
        .stat-label { font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 32px; font-weight: 700; color: #1a202c; margin: 8px 0; }
        .progress-bar { background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #10b981, #059669); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà S&P 500 Upside Predictor</h1>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                <button onclick="showTab('analyze')" id="tabAnalyze" class="tab-button active">
                    üîç Analyze
                </button>
                <button onclick="showTab('admin')" id="tabAdmin" class="tab-button">
                    ‚öôÔ∏è Admin
                </button>
            </div>

            <!-- Analyze Tab -->
            <div id="analyzeTab">
            <div class="auth-section" id="authSection">
                <div id="loginView">
                    <p style="margin-bottom: 12px; color: #0c4a6e; font-weight: 600;">Sign in to save watchlists & get alerts</p>
                    <button onclick="signInWithGoogle()">üîê Sign in with Google</button>
                    <button onclick="signInWithEmail()">üìß Sign in with Email</button>
                </div>
                <div id="userView" style="display: none;">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div style="font-weight: 600; color: #0c4a6e;" id="userName">User</div>
                            <div style="font-size: 12px; color: #475569;" id="userEmail">email@example.com</div>
                        </div>
                        <button onclick="signOut()" style="margin-left: auto; background: #ef4444;">Sign Out</button>
                    </div>
                </div>
            </div>

            <button onclick="initializeData()" id="initBtn" style="width: 100%; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">
                üìä Initialize Historical Data (First Time Only)
            </button>

            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        Minimum Upside (%)
                    </label>
                    <input type="number" id="minUpsideInput" value="0" min="-100" max="100" step="1" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    <span style="font-size: 11px; color: #6b7280;">Show stocks with at least this much predicted gain</span>
                </div>
                <div>
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                        Maximum Downside (%)
                    </label>
                    <input type="number" id="maxDownsideInput" value="-100" min="-100" max="0" step="1"
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    <span style="font-size: 11px; color: #6b7280;">Hide stocks with more downside than this (use negative numbers)</span>
                </div>
            </div>

            <button onclick="analyzeStocks()" id="analyzeBtn" style="width: 100%; padding: 16px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; margin-bottom: 16px;">
                üîç Analyze Top Opportunities
            </button>
        </div>

            <!-- Admin Tab -->
            <div id="adminTab" style="display: none;">
                <h2 style="color: #1a202c; margin-bottom: 16px;">üìä API Usage Dashboard</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Requests (24h)</div>
                        <div class="stat-value" id="totalRequests">-</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #10b981;">
                        <div class="stat-label">Successful</div>
                        <div class="stat-value" style="color: #059669;" id="successfulRequests">-</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ef4444;">
                        <div class="stat-label">Failed</div>
                        <div class="stat-value" style="color: #dc2626;" id="failedRequests">-</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #f59e0b;">
                        <div class="stat-label">Rate Limits Hit</div>
                        <div class="stat-value" style="color: #d97706;" id="rateLimitHits">-</div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                    <h3 style="margin-bottom: 12px;">Daily API Limit Usage</h3>
                    <div style="margin-bottom: 8px; font-size: 14px; color: #6b7280;">
                        <span id="usedRequests">0</span> / <span id="dailyLimit">500</span> requests used
                        <span style="float: right; font-weight: 600;" id="remainingRequests">500 remaining</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                        API Provider: <strong>yahoo-finance15.p.rapidapi.com</strong>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 16px;">Recent Activity</h3>
                    <div id="recentActivity" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #6b7280; text-align: center; padding: 20px;">Loading...</p>
                    </div>
                </div>

                <button onclick="loadAdminStats()" style="width: 100%; padding: 12px; background: #0284c7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 16px;">
                    üîÑ Refresh Stats
                </button>
            </div>
        </div>

        <div class="my-watchlist" id="watchlistSection" style="display: none;">
            <h2 style="margin-bottom: 16px; color: #1a202c;">‚≠ê My Watchlist</h2>
            <div id="watchlistItems"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div>Analyzing stocks...</div>
        </div>

        <div id="results"></div>
    </div>

    <div id="analysisModal" style="display: none;"></div>

    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://enidizmtvmzyqcjwrcew.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuaWRpem10dm16eXFjandyY2V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODgzMzIsImV4cCI6MjA4MjA2NDMzMn0.Zp6Legk87WDZTh4yF2vJmfs76xyXO3JYRn16CSmeEn0'
        );

        let currentUser = null;
        let userWatchlist = [];

        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                updateAuthUI();
                loadWatchlist();
            }
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            updateAuthUI();
            if (currentUser) loadWatchlist();
        });

        function updateAuthUI() {
            const loginView = document.getElementById('loginView');
            const userView = document.getElementById('userView');
            
            if (currentUser) {
                loginView.style.display = 'none';
                userView.style.display = 'block';
                document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || 'User';
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userAvatar').textContent = (currentUser.email || 'U')[0].toUpperCase();
                document.getElementById('watchlistSection').style.display = 'block';
            } else {
                loginView.style.display = 'block';
                userView.style.display = 'none';
                document.getElementById('watchlistSection').style.display = 'none';
            }
        }

        async function signInWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google'
            });
            if (error) alert('Sign in failed: ' + error.message);
        }

        async function signInWithEmail() {
            const email = prompt('Enter your email:');
            if (!email) return;
            
            const { error } = await supabaseClient.auth.signInWithOtp({ email });
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Check your email for the login link!');
            }
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            userWatchlist = [];
        }

        async function loadWatchlist() {
            if (!currentUser) return;
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            try {
                const response = await fetch('/api/watchlist', {
                    headers: {
                        'Authorization': 'Bearer ' + session.access_token
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userWatchlist = data.watchlist || [];
                    displayWatchlist();
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        function displayWatchlist() {
            const container = document.getElementById('watchlistItems');
            
            if (userWatchlist.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No stocks in watchlist yet. Analyze stocks and add them!</p>';
                return;
            }

            container.innerHTML = userWatchlist.map(item => 
                `<div class="watchlist-item">
                    <div>
                        <strong>${item.symbol}</strong> - ${item.name}<br>
                        <small style="color: #6b7280;">
                            Added at $${(item.price_when_added || 0).toFixed(2)} ‚Ä¢ 
                            Target: $${(item.target_when_added || 0).toFixed(2)} ‚Ä¢ 
                            Upside: ${(item.upside_when_added || 0).toFixed(1)}%
                        </small>
                    </div>
                    <button class="remove-btn" onclick="removeFromWatchlist('${item.symbol}')">Remove</button>
                </div>`
            ).join('');
        }

        async function addToWatchlist(stock) {
            if (!currentUser) {
                alert('Please sign in to save watchlists');
                return;
            }

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + session.access_token
                    },
                    body: JSON.stringify({
                        symbol: stock.symbol,
                        name: stock.name,
                        price: stock.currentPrice,
                        target: stock.predictedPrice,
                        upside: stock.predictedUpside
                    })
                });

                if (response.ok) {
                    alert('‚úÖ ' + stock.symbol + ' added to watchlist!');
                    loadWatchlist();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to add to watchlist'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm('Remove ' + symbol + ' from watchlist?')) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            try {
                const response = await fetch('/api/watchlist?symbol=' + symbol, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + session.access_token
                    }
                });

                if (response.ok) {
                    loadWatchlist();
                }
            } catch (error) {
                console.error('Error removing from watchlist:', error);
            }
        }

        async function initializeData() {
            const btn = document.getElementById('initBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            if (!confirm('This will collect 90 days of historical data for 40 stocks. It may take 2-3 minutes. Continue?')) {
                return;
            }

            loading.style.display = 'block';
            results.innerHTML = '';
            btn.disabled = true;
            btn.textContent = '‚è≥ Initializing data...';

            try {
                const response = await fetch('/api/initialize-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error('Initialization failed');

                const data = await response.json();
                
                results.innerHTML = `<div class="stock-card">
                    <h2 style="color: #059669;">‚úÖ Data Initialization Complete!</h2>
                    <p style="margin-top: 12px;">Processed ${data.results.processed} stocks successfully.</p>
                    <p style="margin-top: 8px; color: #6b7280;">You can now click "Analyze Top Opportunities" to get predictions!</p>
                </div>`;

                alert('‚úÖ Historical data loaded! You can now analyze stocks.');

            } catch (error) {
                console.error('Initialization error:', error);
                results.innerHTML = `<div class="stock-card">
                    <div class="error-box">
                        <strong>Error:</strong> ${error.message}
                    </div>
                </div>`;
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'üìä Initialize Historical Data (First Time Only)';
            }
        }

        async function analyzeStocks() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const btn = document.getElementById('analyzeBtn');

            loading.style.display = 'block';
            results.innerHTML = '';
            btn.disabled = true;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: ['AAPL','MSFT','NVDA','AMZN','GOOGL','META','TSLA','UNH','XOM','JPM','JNJ','V','PG','MA','HD','CVX','MRK','ABBV','LLY','AVGO'],
                        minUpside: 0
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.error || 'Analysis failed');
                }

                const data = await response.json();
                console.log('API Response:', data);
                displayResults(data.opportunities || []);

            } catch (error) {
                console.error('Analysis error:', error);
                results.innerHTML = `<div class="stock-card">
                    <div class="error-box">
                        <strong>Error:</strong> ${error.message}<br>
                        <small>Check the browser console (F12) for more details</small>
                    </div>
                </div>`;
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function displayResults(opportunities) {
            const results = document.getElementById('results');
            
            if (!opportunities || opportunities.length === 0) {
                results.innerHTML = '<div class="stock-card"><h2>No opportunities found</h2><p>Try lowering the minimum upside threshold or check if the API key is configured correctly.</p></div>';
                return;
            }

            results.innerHTML = opportunities.map(stock => {
                const isInWatchlist = userWatchlist.some(item => item.symbol === stock.symbol);
                
                return `<div class="stock-card" onclick='showAnalysis(${JSON.stringify(stock).replace(/'/g, "&#39;")})'>
                    <div class="stock-header">
                        <div>
                            <div class="stock-symbol">${stock.symbol}</div>
                            <div style="font-size: 13px; color: #718096;">${stock.name}</div>
                        </div>
                        ${currentUser ? `<button class="watchlist-btn ${isInWatchlist ? 'added' : ''}" 
                            onclick='event.stopPropagation(); addToWatchlist(${JSON.stringify(stock).replace(/'/g, "&#39;")})'>
                            ${isInWatchlist ? '‚úì In Watchlist' : '‚≠ê Add to Watchlist'}
                        </button>` : ''}
                    </div>
                    <div class="stock-price">$${stock.currentPrice.toFixed(2)}</div>
                    <div class="upside-box">
                        <div style="font-size: 12px; color: #065f46; font-weight: 600;">30-DAY UPSIDE POTENTIAL</div>
                        <div class="upside-value">+${stock.predictedUpside.toFixed(1)}%</div>
                        <div style="font-size: 12px; color: #065f46; margin-top: 4px;">Target: $${stock.predictedPrice.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 12px;">
                        ${(stock.signals || []).slice(0, 3).map(sig => 
                            `<div style="font-size: 13px; color: #065f46; margin-bottom: 4px;">
                                ${sig.bullish ? '‚úì' : '‚óã'} ${sig.text}
                            </div>`
                        ).join('')}
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 13px; color: #6b7280; font-weight: 600;">
                        üîç Click for detailed technical analysis
                    </div>
                </div>`;
            }).join('');
        }

        function showAnalysis(stock) {
            const modal = document.getElementById('analysisModal');
            const tech = stock.technical || {};
            
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeAnalysis(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeAnalysis()">√ó</button>
                        
                        <h1 style="font-size: 28px; color: #1a202c; margin-bottom: 8px;">${stock.symbol} Technical Analysis</h1>
                        <div style="font-size: 16px; color: #6b7280; margin-bottom: 24px;">Current Price: $${stock.currentPrice.toFixed(2)}</div>
                        
                        <div class="score-grid">
                            <div class="score-card">
                                <div class="score-label">Combined Score</div>
                                <div class="score-value" style="color: ${stock.combinedScore > 60 ? '#059669' : stock.combinedScore > 40 ? '#f59e0b' : '#ef4444'}">
                                    ${stock.combinedScore.toFixed(0)}/100
                                </div>
                            </div>
                            <div class="score-card">
                                <div class="score-label">Technical Score</div>
                                <div class="score-value" style="color: ${stock.technicalScore > 60 ? '#059669' : stock.technicalScore > 40 ? '#f59e0b' : '#ef4444'}">
                                    ${stock.technicalScore.toFixed(0)}/100
                                </div>
                            </div>
                            <div class="score-card">
                                <div class="score-label">Analyst Score</div>
                                <div class="score-value" style="color: ${stock.analystScore > 60 ? '#059669' : stock.analystScore > 40 ? '#f59e0b' : '#ef4444'}">
                                    ${stock.analystScore.toFixed(0)}/100
                                </div>
                            </div>
                            <div class="score-card">
                                <div class="score-label">Confidence</div>
                                <div class="score-value" style="color: ${stock.confidence > 70 ? '#059669' : stock.confidence > 50 ? '#f59e0b' : '#ef4444'}">
                                    ${stock.confidence.toFixed(0)}%
                                </div>
                            </div>
                        </div>

                        <div class="section-title">üìä Technical Indicators</div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                            <div class="indicator-row">
                                <div class="indicator-label">RSI (14-day)</div>
                                <div class="indicator-value" style="color: ${tech.rsi < 30 ? '#059669' : tech.rsi > 70 ? '#ef4444' : '#f59e0b'}">
                                    ${tech.rsi?.toFixed(2) || 'N/A'}
                                    ${tech.rsi < 30 ? ' (Oversold üìà)' : tech.rsi > 70 ? ' (Overbought üìâ)' : ' (Neutral)'}
                                </div>
                            </div>
                            <div class="indicator-row">
                                <div class="indicator-label">20-Day SMA</div>
                                <div class="indicator-value">$${tech.sma20?.toFixed(2) || 'N/A'}</div>
                            </div>
                            <div class="indicator-row">
                                <div class="indicator-label">50-Day SMA</div>
                                <div class="indicator-value">$${tech.sma50?.toFixed(2) || 'N/A'}</div>
                            </div>
                            <div class="indicator-row">
                                <div class="indicator-label">Momentum (10-day)</div>
                                <div class="indicator-value" style="color: ${tech.momentum > 5 ? '#059669' : tech.momentum < -5 ? '#ef4444' : '#f59e0b'}">
                                    ${tech.momentum > 0 ? '+' : ''}${tech.momentum?.toFixed(2) || 'N/A'}%
                                </div>
                            </div>
                            <div class="indicator-row" style="border-bottom: none;">
                                <div class="indicator-label">Volatility (30-day)</div>
                                <div class="indicator-value" style="color: ${tech.volatility < 2 ? '#059669' : tech.volatility > 5 ? '#ef4444' : '#f59e0b'}">
                                    ${tech.volatility?.toFixed(2) || 'N/A'}%
                                </div>
                            </div>
                        </div>

                        <div class="section-title">üßÆ Score Calculation Breakdown</div>
                        
                        <div class="calculation-box">
                            <div style="font-weight: 700; margin-bottom: 8px;">Technical Score: ${stock.technicalScore.toFixed(0)}/100</div>
                            <div style="font-size: 14px; line-height: 1.6;">
                                Technical Score (40%): ${stock.technicalScore.toFixed(0)} √ó 0.40 = ${(stock.technicalScore * 0.4).toFixed(1)}<br>
                                Analyst Score (40%): ${stock.analystScore.toFixed(0)} √ó 0.40 = ${(stock.analystScore * 0.4).toFixed(1)}<br>
                                Sentiment Score (20%): ${stock.sentimentScore.toFixed(0)} √ó 0.20 = ${(stock.sentimentScore * 0.2).toFixed(1)}<br>
                                <strong style="color: #1a202c; margin-top: 8px; display: block;">Total: ${stock.combinedScore.toFixed(0)}/100</strong>
                            </div>
                        </div>

                        <div class="section-title">üéØ Price Prediction</div>
                        <div style="background: #d1fae5; padding: 16px; border-radius: 8px; border-left: 4px solid #059669;">
                            <div style="font-size: 14px; color: #065f46; margin-bottom: 12px;">
                                <strong>Current Price:</strong> ${stock.currentPrice.toFixed(2)}<br>
                                <strong>30-Day Target:</strong> ${stock.predictedPrice.toFixed(2)}<br>
                                <strong>Expected Gain:</strong> +${stock.predictedUpside.toFixed(1)}% (${((stock.predictedPrice - stock.currentPrice)).toFixed(2)} points)
                            </div>
                            <div style="font-size: 13px; color: #065f46; line-height: 1.6;">
                                <strong>Prediction Formula:</strong><br>
                                Momentum Impact: ${(tech.momentum * 0.5).toFixed(2)}%<br>
                                + Analyst Influence: ${stock.analystScore > 50 ? ((stock.analystScore - 50) / 2 * 0.3).toFixed(2) : '0.00'}%<br>
                                = Total Predicted Upside: ${stock.predictedUpside.toFixed(2)}%
                            </div>
                        </div>

                        <div class="section-title">üìå Trading Signals</div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            ${stock.signals.map(sig => 
                                `<div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
                                    <span style="font-size: 18px; margin-right: 8px;">${sig.bullish ? '‚úÖ' : '‚≠ï'}</span>
                                    <span style="color: ${sig.bullish ? '#059669' : '#6b7280'};">${sig.text}</span>
                                </div>`
                            ).join('')}
                        </div>

                        <div style="margin-top: 24px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #92400e; line-height: 1.6;">
                                <strong>‚ö†Ô∏è Disclaimer:</strong> This analysis is for educational purposes only. Past performance does not guarantee future results. 
                                Always conduct your own research and consider consulting with a financial advisor before making investment decisions.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeAnalysis(event) {
            if (event && event.target.className !== 'modal-overlay' && event.target.className !== 'modal-close') {
                return;
            }
            document.getElementById('analysisModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Tab switching
        function showTab(tabName) {
            const analyzeTab = document.getElementById('analyzeTab');
            const adminTab = document.getElementById('adminTab');
            const btnAnalyze = document.getElementById('tabAnalyze');
            const btnAdmin = document.getElementById('tabAdmin');

            if (tabName === 'analyze') {
                analyzeTab.style.display = 'block';
                adminTab.style.display = 'none';
                btnAnalyze.classList.add('active');
                btnAdmin.classList.remove('active');
            } else if (tabName === 'admin') {
                analyzeTab.style.display = 'none';
                adminTab.style.display = 'block';
                btnAnalyze.classList.remove('active');
                btnAdmin.classList.add('active');
                loadAdminStats();
            }
        }

        // Load admin statistics
        async function loadAdminStats() {
            try {
                const response = await fetch('/api/admin-stats');
                const data = await response.json();

                if (data.success) {
                    // Update stat cards
                    document.getElementById('totalRequests').textContent = data.last24Hours.totalRequests;
                    document.getElementById('successfulRequests').textContent = data.last24Hours.successfulRequests;
                    document.getElementById('failedRequests').textContent = data.last24Hours.failedRequests;
                    document.getElementById('rateLimitHits').textContent = data.last24Hours.rateLimitHits;

                    // Update progress bar
                    document.getElementById('usedRequests').textContent = data.last24Hours.totalRequests;
                    document.getElementById('dailyLimit').textContent = data.dailyLimit;
                    document.getElementById('remainingRequests').textContent = data.remainingRequests;
                    
                    const progressFill = document.getElementById('progressFill');
                    const percentage = parseFloat(data.percentageUsed);
                    progressFill.style.width = percentage + '%';
                    progressFill.textContent = percentage.toFixed(1) + '%';
                    
                    // Change color based on usage
                    if (percentage > 80) {
                        progressFill.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                    } else if (percentage > 60) {
                        progressFill.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                    }

                    // Display recent activity
                    const activityHTML = data.recentActivity.length > 0
                        ? data.recentActivity.map(activity => {
                            const time = new Date(activity.timestamp).toLocaleTimeString();
                            const successRate = activity.requests > 0 
                                ? ((activity.successful / activity.requests) * 100).toFixed(0)
                                : 0;
                            
                            return `
                                <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #1a202c;">${time}</div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${activity.requests} requests ‚Ä¢ ${successRate}% success rate
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; color: #059669;">‚úì ${activity.successful}</div>
                                        ${activity.failed > 0 ? `<div style="font-size: 14px; color: #dc2626;">‚úó ${activity.failed}</div>` : ''}
                                        ${activity.rateLimited > 0 ? `<div style="font-size: 12px; color: #d97706;">‚ö† ${activity.rateLimited} limited</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')
                        : '<p style="color: #6b7280; text-align: center; padding: 20px;">No activity in the last 24 hours</p>';

                    document.getElementById('recentActivity').innerHTML = activityHTML;
                }
            } catch (error) {
                console.error('Failed to load admin stats:', error);
                document.getElementById('recentActivity').innerHTML = 
                    '<p style="color: #dc2626; text-align: center; padding: 20px;">Failed to load statistics</p>';
            }
        }
    </script>
</body>
</html>Base Score: 50 (neutral)<br>
                                ${tech.rsi < 30 ? '+ 15 points (RSI oversold - bullish signal)' : tech.rsi > 70 ? '- 15 points (RSI overbought - bearish signal)' : '+ 0 points (RSI neutral)'}<br>
                                ${tech.momentum > 5 ? '+ 15 points (strong positive momentum)' : tech.momentum > 0 ? '+ 5 points (positive momentum)' : tech.momentum < -5 ? '- 15 points (strong negative momentum)' : '- 5 points (negative momentum)'}<br>
                                ${tech.currentPrice > tech.sma20 ? '+ 10 points (price above 20-day SMA)' : '+ 0 points (price below 20-day SMA)'}<br>
                                ${tech.sma20 > tech.sma50 ? '+ 10 points (20-day SMA above 50-day SMA)' : '+ 0 points'}<br>
                                ${tech.volatility < 2 ? '+ 10 points (low volatility)' : tech.volatility > 5 ? '- 10 points (high volatility)' : '+ 0 points (moderate volatility)'}
                            </div>
                        </div>

                        <div class="calculation-box" style="background: #dbeafe; border-left-color: #0284c7;">
                            <div style="font-weight: 700; margin-bottom: 8px;">Combined Score Weighting</div>
                            <div style="font-size: 14px; line-height: 1.6;">
                                